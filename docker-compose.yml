# Docker Compose for Game Controller System
#
# This compose file starts the complete game system:
# - decision_making: Phase-based FSM for game logic
# - game_controller: Game orchestration and UI integration
# - generic_ui backend: WebSocket gateway for UI
# - generic_ui web: React-based UI shell
#
# Usage:
#   docker compose up
#
# To run with rebuild:
#   docker compose up --build

services:
  # Decision Making - Phase-based FSM
  decision_making:
    build:
      context: ../refactored_game/decision_making_ws
      dockerfile: Dockerfile
    environment:
      ROS_DOMAIN_ID: 0
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "source /opt/ros/humble/setup.bash && ros2 node list | grep -q decision_making"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 15s

  # Game Controller - Orchestration
  game_controller:
    image: game_controller_runtime:latest
    build:
      context: ..
      dockerfile: game_controller/game_controller/Dockerfile.compose
      network: host
    environment:
      ROS_DOMAIN_ID: 0
      # Shared base where module-federation and shared assets are served.
      EMOROBCARE_COMPONENTS_BASE_URL: "${EMOROBCARE_COMPONENTS_BASE_URL:-http://localhost:8084/emorobcare-components}"
      # Project/game image assets derived from the same CDN by default.
      # Override when deploying project assets elsewhere.
      EMOROBCARE_PROJECT_ASSET_BASE_URL: "${EMOROBCARE_PROJECT_ASSET_BASE_URL:-http://localhost:8084/emorobcare-components/images}"
      PROJECT_ASSET_BASE_URL: "${EMOROBCARE_PROJECT_ASSET_BASE_URL:-http://localhost:8084/emorobcare-components/images}"
      GAME_CONTROLLER_REMOTE_ENTRY_BASE_URL: "${EMOROBCARE_COMPONENTS_BASE_URL:-http://localhost:8084/emorobcare-components}"
      SHARED_ASSET_BASE_URL: "${EMOROBCARE_COMPONENTS_BASE_URL:-http://localhost:8084/emorobcare-components}"
      GAME_CONTROLLER_DB_ENABLED: "${GAME_CONTROLLER_DB_ENABLED:-1}"
      POSTGRES_DB: "${POSTGRES_DB:-emorobcare_db}"
      POSTGRES_USER: "${POSTGRES_USER:-emorobcare}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-D3B3rdad.Emylio}"
      POSTGRES_HOST: "${POSTGRES_HOST:-10.147.19.11}"
      POSTGRES_PORT: "${POSTGRES_PORT:-5432}"
    volumes:
      # Mount game content for development
      - ./game_controller/games:/ros2_ws/src/game_controller/games:ro
    depends_on:
      decision_making:
        condition: service_healthy
      communication_hub:
        condition: service_healthy
      expressive_say_bridge:
        condition: service_healthy
      llm_service:
        condition: service_healthy
      led_service_ros:
        condition: service_healthy
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "source /opt/ros/humble/setup.bash && source /ros2_ws/install/setup.bash && ros2 node list | grep -q game_controller"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 15s

  communication_hub:
    image: game_controller_runtime:latest
    build:
      context: ..
      dockerfile: game_controller/game_controller/Dockerfile.compose
      network: host
    environment:
      ROS_DOMAIN_ID: 0
    command: ["ros2", "run", "game_controller", "ui_intent_bridge"]
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "source /opt/ros/humble/setup.bash && source /ros2_ws/install/setup.bash && ros2 node list | grep -q communication_hub_ui_intent_bridge"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  # Mock communication_hub expressive path: /expressive_say -> /say
  expressive_say_bridge:
    image: game_controller_runtime:latest
    build:
      context: ..
      dockerfile: game_controller/game_controller/Dockerfile.compose
      network: host
    environment:
      ROS_DOMAIN_ID: 0
    command: ["ros2", "run", "game_controller", "expressive_say_bridge_mock"]
    depends_on:
      tts_mock:
        condition: service_healthy
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "source /opt/ros/humble/setup.bash && source /ros2_ws/install/setup.bash && ros2 action list | grep -q /expressive_say"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  # Browser-backed TTS mock for local laptop audio
  tts_mock:
    image: game_controller_runtime:latest
    build:
      context: ..
      dockerfile: game_controller/game_controller/Dockerfile.compose
      network: host
    environment:
      ROS_DOMAIN_ID: 0
      TTS_MOCK_UI_HOST: "0.0.0.0"
      TTS_MOCK_UI_PORT: 8096
    command: ["ros2", "run", "game_controller", "tts_mock_node"]
    ports:
      - "8096:8096"
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8096/healthz', timeout=2)\""]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  # Mock LLM services for /chatbot/*
  llm_service:
    image: game_controller_runtime:latest
    build:
      context: ..
      dockerfile: game_controller/game_controller/Dockerfile.compose
      network: host
    environment:
      ROS_DOMAIN_ID: 0
    command: ["ros2", "run", "llm_service_mock", "llm_service_mock_node"]
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "source /opt/ros/humble/setup.bash && source /ros2_ws/install/setup.bash && ros2 service list | grep -q /chatbot/rephrase"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  # LED ROS service (mock backend when hardware is unavailable)
  led_service_ros:
    image: game_controller_runtime:latest
    build:
      context: ..
      dockerfile: game_controller/game_controller/Dockerfile.compose
      network: host
    environment:
      ROS_DOMAIN_ID: 0
      LED_USE_MOCK: "${LED_USE_MOCK:-1}"
      LED_NUM_LEDS: "${LED_NUM_LEDS:-5}"
    command: ["ros2", "run", "emorobcare_led_service", "led_service_node"]
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "source /opt/ros/humble/setup.bash && source /ros2_ws/install/setup.bash && ros2 service list | grep -q /set_leds"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  # Simple web UI that interacts with led_service_ros
  led_service_mock:
    image: game_controller_runtime:latest
    build:
      context: ..
      dockerfile: game_controller/game_controller/Dockerfile.compose
      network: host
    environment:
      ROS_DOMAIN_ID: 0
      LED_MOCK_UI_HOST: "0.0.0.0"
      LED_MOCK_UI_PORT: 8095
    command: ["ros2", "run", "led_service_mock", "led_service_mock_node"]
    depends_on:
      led_service_ros:
        condition: service_healthy
    ports:
      - "8095:8095"
    networks:
      - rosnet
    healthcheck:
      test: ["CMD", "bash", "-c", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8095/healthz', timeout=2)\""]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 10s

  # Generic UI Backend
  backend:
    build:
      context: ../generic_ui
      dockerfile: backend/Dockerfile
      network: host
    environment:
      ROS_DOMAIN_ID: 0
      UI_GATEWAY_PORT: 8080
      # Don't load demo manifest - wait for game_controller
      UI_SIMPLE_UI_DEMO: "0"
      UI_MANIFEST_PATH: ""
    depends_on:
      decision_making:
        condition: service_healthy
    ports:
      - "8092:8080"
    networks:
      - rosnet

  # React UI shell
  web:
    build:
      context: ../generic_ui
      dockerfile: web/Dockerfile
      network: host
    depends_on:
      - backend
    ports:
      - "8083:80"
    networks:
      - rosnet

  # CDN for emorobcare UI components
  emorobcare_components_cdn:
    build:
      context: ../generic_ui
      dockerfile: emorobcare_components/Dockerfile
      network: host
    depends_on:
      - web
    ports:
      - "8084:80"
    networks:
      - rosnet

networks:
  rosnet:
    driver: bridge
